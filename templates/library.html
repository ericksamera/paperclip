{% extends "base.html" %}
{% block title %}Library · Paperclip{% endblock %}

{% block content %}
  <div class="layout">
    <aside class="sidebar">
      <div class="panel">
        <div class="panel__title">Collections</div>
        <div class="panel__body">
          <div class="col-item">
            <a
              class="{% if not selected_col %}active{% endif %}"
              href="{{ url_for('library', q=q, page_size=page_size) }}"
              >All</a
            >
            <span class="muted">{{ total_all }}</span>
          </div>

          {% for c in collections %}
            <div class="col-item">
              <a
                class="{% if selected_col == (c.id|string) %}active{% endif %}"
                href="{{ url_for('library', col=c.id, q=q, page_size=page_size) }}"
              >
                {{ c.name }}
              </a>
              <span class="muted">{{ c.count }}</span>
            </div>
          {% endfor %}
        </div>
      </div>
    </aside>

    <main class="content">
      <div class="panel">
        <div class="panel__title">Library</div>
        <div class="panel__body">
          <form
            id="search-form"
            class="search"
            method="get"
            action="{{ url_for('library') }}"
          >
            <input type="hidden" name="col" value="{{ selected_col }}" />
            <input
              class="search__input"
              type="text"
              name="q"
              value="{{ q }}"
              placeholder="Search title, url, DOI, content…"
            />
            <button class="btn btn--primary" type="submit">Search</button>
            <select
              class="select"
              name="page_size"
              id="page-size"
              title="Page size"
            >
              <option value="25" {% if page_size == 25 %}selected{% endif %}>
                25
              </option>
              <option value="50" {% if page_size == 50 %}selected{% endif %}>
                50
              </option>
              <option value="100" {% if page_size == 100 %}selected{% endif %}>
                100
              </option>
            </select>
            {% if q %}
              <a
                class="btn"
                href="{{ url_for('library', col=selected_col, page_size=page_size) }}"
                >Clear</a
              >
            {% endif %}
          </form>

          <div class="panel-row">
            <div class="muted small">
              {{ total }} result{{ "" if total == 1 else "s" }}
            </div>
            <div class="exports">
              <a
                class="btn"
                href="{{ url_for('export_bibtex', col=selected_col) }}"
                >Export BibTeX</a
              >
              <a
                class="btn"
                href="{{ url_for('export_ris', col=selected_col) }}"
                >Export RIS</a
              >
            </div>
          </div>

          <form method="post" action="{{ url_for('captures_delete') }}">
            <input type="hidden" name="next" value="{{ request.full_path }}" />

            <div class="bulkbar">
              <label class="small"
                ><input type="checkbox" id="select-all" /> Select all</label
              >

              <div class="bulk-actions">
                <select class="select" name="collection_id">
                  <option value="">Choose collection…</option>
                  {% for c in collections %}
                    <option value="{{ c.id }}">{{ c.name }}</option>
                  {% endfor %}
                </select>

                <button
                  class="btn"
                  type="submit"
                  formaction="{{ url_for('captures_collections_add') }}"
                >
                  Add to collection
                </button>
                <button
                  class="btn"
                  type="submit"
                  formaction="{{ url_for('captures_collections_remove') }}"
                >
                  Remove from collection
                </button>
                <button
                  class="btn"
                  type="submit"
                  formaction="{{ url_for('export_selected_bibtex') }}"
                >
                  Export selected (BibTeX)
                </button>
                <button
                  class="btn"
                  type="submit"
                  formaction="{{ url_for('export_selected_ris') }}"
                >
                  Export selected (RIS)
                </button>
                <button class="btn btn--danger" type="submit">
                  Delete selected
                </button>
              </div>
            </div>

            <div class="table-wrap">
              <table class="table">
                <thead>
                  <tr>
                    <th class="sel"></th>
                    <th>Title</th>
                    <th>Authors</th>
                    <th>Year</th>
                    <th>Container</th>
                    <th>DOI</th>
                  </tr>
                </thead>
                <tbody id="library-tbody">
                  {% for cap in captures %}
                    <tr>
                      <td class="sel">
                        <input
                          class="cap-check"
                          type="checkbox"
                          name="capture_ids"
                          value="{{ cap.id }}"
                        />
                      </td>

                      <td class="title-cell">
                        <a
                          class="title-link"
                          href="{{ url_for('capture_detail', capture_id=cap.id) }}"
                        >
                          {{ cap.title }}
                        </a>
                        {% if cap.abstract_snip %}
                          <div class="muted small">{{ cap.abstract_snip }}</div>
                        {% endif %}
                        <div class="muted small">
                          <a
                            href="{{ cap.url }}"
                            target="_blank"
                            rel="noopener noreferrer"
                            >{{ cap.url }}</a
                          >
                        </div>
                      </td>

                      <td class="small">
                        {{ cap.authors_short or cap.authors_str or "" }}
                      </td>
                      <td class="small">{{ cap.year or "" }}</td>
                      <td class="small">{{ cap.container_title or "" }}</td>
                      <td class="small">{{ cap.doi or "" }}</td>
                    </tr>
                  {% endfor %}

                  {% if captures|length == 0 %}
                    <tr data-empty="1">
                      <td colspan="6" class="muted">No captures found.</td>
                    </tr>
                  {% endif %}
                </tbody>
              </table>
            </div>

            <div
              id="infinite-loading"
              class="muted small"
              style="margin-top: 8px; display: none"
            >
              Loading…
            </div>
            <div
              id="infinite-end"
              class="muted small"
              style="margin-top: 8px; display: none"
            >
              End of results.
            </div>
            <div
              id="infinite-error"
              class="muted small"
              style="margin-top: 8px; display: none"
            ></div>
            <div id="infinite-sentinel" style="height: 1px"></div>

            <div
              id="library-config"
              data-api-base="{{ url_for('api_library') }}"
              data-detail-url-template="{{ url_for('capture_detail', capture_id='__CID__') }}"
              data-next-page="{{ page + 1 }}"
              data-page-size="{{ page_size }}"
              data-has-more="{{ 1 if has_more else 0 }}"
              style="display: none"
            ></div>
          </form>
        </div>
      </div>
    </main>
  </div>

  <script>
    (function () {
      const selectAll = document.getElementById("select-all");
      const tbody = document.getElementById("library-tbody");
      const sentinel = document.getElementById("infinite-sentinel");
      const loadingEl = document.getElementById("infinite-loading");
      const endEl = document.getElementById("infinite-end");
      const errorEl = document.getElementById("infinite-error");
      const cfgEl = document.getElementById("library-config");

      // Page size dropdown: reload via regular navigation (GET).
      const pageSizeSelect = document.getElementById("page-size");
      const searchForm = document.getElementById("search-form");
      if (pageSizeSelect && searchForm) {
        pageSizeSelect.addEventListener("change", () => {
          searchForm.submit();
        });
      }

      function allBoxes() {
        return document.querySelectorAll(
          'input[type="checkbox"][name="capture_ids"]',
        );
      }

      function syncSelectAllState() {
        if (!selectAll) return;
        const boxes = allBoxes();
        if (boxes.length === 0) {
          selectAll.checked = false;
          selectAll.indeterminate = false;
          return;
        }

        let checked = 0;
        boxes.forEach((b) => {
          if (b.checked) checked += 1;
        });

        if (checked === 0) {
          selectAll.checked = false;
          selectAll.indeterminate = false;
        } else if (checked === boxes.length) {
          selectAll.checked = true;
          selectAll.indeterminate = false;
        } else {
          selectAll.checked = false;
          selectAll.indeterminate = true;
        }
      }

      if (selectAll) {
        selectAll.addEventListener("change", () => {
          const boxes = allBoxes();
          boxes.forEach((b) => (b.checked = selectAll.checked));
          selectAll.indeterminate = false;
        });
      }

      document.addEventListener("change", (ev) => {
        const t = ev.target;
        if (
          t &&
          t.matches &&
          t.matches('input[type="checkbox"][name="capture_ids"]')
        ) {
          syncSelectAllState();
        }
      });

      // --- Infinite scroll ---
      if (!tbody || !sentinel || !cfgEl) {
        syncSelectAllState();
        return;
      }

      const API_BASE = cfgEl.dataset.apiBase || "/api/library/";
      const DETAIL_TMPL =
        cfgEl.dataset.detailUrlTemplate || "/captures/__CID__/";

      let nextPage = parseInt(cfgEl.dataset.nextPage || "2", 10);
      let pageSize = parseInt(cfgEl.dataset.pageSize || "50", 10);
      let hasMore = cfgEl.dataset.hasMore === "1";
      let loading = false;
      let endShown = false;

      function setLoading(on) {
        if (!loadingEl) return;
        loadingEl.style.display = on ? "block" : "none";
      }

      function showEnd() {
        if (!endEl || endShown) return;
        endEl.style.display = "block";
        endShown = true;
      }

      function showError(msg) {
        if (!errorEl) return;
        errorEl.textContent = msg;
        errorEl.style.display = "block";
      }

      function hideError() {
        if (!errorEl) return;
        errorEl.style.display = "none";
      }

      function currentFilters() {
        const sp = new URLSearchParams(window.location.search);
        const q = (sp.get("q") || "").trim();
        const col = (sp.get("col") || "").trim();
        const ps = (sp.get("page_size") || String(pageSize)).trim();
        return { q, col, page_size: ps };
      }

      function buildApiUrl(page) {
        const f = currentFilters();
        const sp = new URLSearchParams();
        if (f.q) sp.set("q", f.q);
        if (f.col) sp.set("col", f.col);
        sp.set("page", String(page));
        sp.set("page_size", f.page_size || String(pageSize));
        return API_BASE + "?" + sp.toString();
      }

      function captureDetailUrl(id) {
        return DETAIL_TMPL.replace("__CID__", encodeURIComponent(id));
      }

      function removeEmptyRowIfPresent() {
        const emptyRow = tbody.querySelector("tr[data-empty='1']");
        if (emptyRow) emptyRow.remove();
      }

      function appendRow(cap) {
        if (!cap || !cap.id) return;

        removeEmptyRowIfPresent();

        const tr = document.createElement("tr");

        const tdSel = document.createElement("td");
        tdSel.className = "sel";
        const cb = document.createElement("input");
        cb.className = "cap-check";
        cb.type = "checkbox";
        cb.name = "capture_ids";
        cb.value = cap.id;
        if (selectAll && selectAll.checked) cb.checked = true;
        tdSel.appendChild(cb);
        tr.appendChild(tdSel);

        const tdTitle = document.createElement("td");
        tdTitle.className = "title-cell";

        const aTitle = document.createElement("a");
        aTitle.className = "title-link";
        aTitle.href = captureDetailUrl(cap.id);
        aTitle.textContent = cap.title || "Untitled";
        tdTitle.appendChild(aTitle);

        if (cap.abstract_snip) {
          const divAbs = document.createElement("div");
          divAbs.className = "muted small";
          divAbs.textContent = cap.abstract_snip;
          tdTitle.appendChild(divAbs);
        }

        if (cap.url) {
          const divUrl = document.createElement("div");
          divUrl.className = "muted small";
          const aUrl = document.createElement("a");
          aUrl.href = cap.url;
          aUrl.target = "_blank";
          aUrl.rel = "noopener noreferrer";
          aUrl.textContent = cap.url;
          divUrl.appendChild(aUrl);
          tdTitle.appendChild(divUrl);
        }

        tr.appendChild(tdTitle);

        const tdAuthors = document.createElement("td");
        tdAuthors.className = "small";
        tdAuthors.textContent = cap.authors_short || "";
        tr.appendChild(tdAuthors);

        const tdYear = document.createElement("td");
        tdYear.className = "small";
        tdYear.textContent = cap.year || "";
        tr.appendChild(tdYear);

        const tdContainer = document.createElement("td");
        tdContainer.className = "small";
        tdContainer.textContent = cap.container_title || "";
        tr.appendChild(tdContainer);

        const tdDoi = document.createElement("td");
        tdDoi.className = "small";
        tdDoi.textContent = cap.doi || "";
        tr.appendChild(tdDoi);

        tbody.appendChild(tr);
      }

      async function loadNext() {
        if (!hasMore || loading) return;

        loading = true;
        setLoading(true);
        hideError();

        try {
          const resp = await fetch(buildApiUrl(nextPage), {
            headers: { Accept: "application/json" },
          });
          if (!resp.ok) throw new Error(`HTTP ${resp.status}`);

          const data = await resp.json();
          const caps =
            data && Array.isArray(data.captures) ? data.captures : [];
          caps.forEach((cap) => appendRow(cap));

          hasMore = !!(data && data.has_more);
          const currentPage =
            data && data.page != null ? Number(data.page) : nextPage;
          nextPage = currentPage + 1;

          if (!hasMore) {
            observer.disconnect();
            showEnd();
          }

          syncSelectAllState();
        } catch (e) {
          console.warn("Infinite scroll fetch failed:", e);
          showError("Couldn’t load more results. Scroll to retry.");
        } finally {
          loading = false;
          setLoading(false);
        }
      }

      const observer = new IntersectionObserver(
        (entries) => {
          for (const entry of entries) {
            if (entry.isIntersecting) loadNext();
          }
        },
        { root: null, rootMargin: "300px 0px", threshold: 0 },
      );

      if (hasMore) {
        observer.observe(sentinel);
      } else {
        showEnd();
      }

      syncSelectAllState();
    })();
  </script>
{% endblock %}
