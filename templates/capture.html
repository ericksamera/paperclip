{% extends "base.html" %}
{% block title %}{{ capture.title }} · Paperclip{% endblock %}

{% block content %}
  <div class="panel">
    <div class="panel__title">Capture</div>
    <div class="panel__body">
      <div class="capture-head">
        <div class="capture-sub">
          <h2 class="capture-title">{{ capture.title }}</h2>

          {% if citation.authors_str %}
            <div class="muted small">{{ citation.authors_str }}</div>
          {% endif %}

          <div class="muted small">
            <a
              href="{{ capture.url }}"
              target="_blank"
              rel="noopener noreferrer"
            >
              {{ capture.url }}
            </a>
          </div>

          {% if meta.abstract %}
            <div style="margin-top: 6px">
              <div class="muted small" style="margin-bottom: 4px">Abstract</div>
              <div>{{ meta.abstract }}</div>
            </div>
          {% endif %}
        </div>

        <div class="capture-actions">
          <a
            class="btn btn--sm"
            href="{{ url_for('export_bibtex', capture_id=capture.id) }}"
            >BibTeX</a
          >
          <a
            class="btn btn--sm"
            href="{{ url_for('export_ris', capture_id=capture.id) }}"
            >RIS</a
          >
          <a
            class="btn btn--sm"
            href="{{ url_for('export_sections_json', capture_id=capture.id) }}"
            >Sections JSON</a
          >
          <a
            class="btn btn--sm"
            href="{{ url_for('export_papers_jsonl', capture_id=capture.id) }}"
            >Papers JSONL</a
          >
          <a
            class="btn btn--sm"
            href="{{ url_for('export_master_md', capture_id=capture.id) }}"
            >Master MD</a
          >

          <form
            method="post"
            action="{{ url_for('captures_delete') }}"
            onsubmit="return confirm('Delete this capture?')"
          >
            <input type="hidden" name="capture_ids" value="{{ capture.id }}" />
            <input type="hidden" name="next" value="{{ url_for('library') }}" />
            <button class="btn btn--danger btn--sm" type="submit">
              Delete
            </button>
          </form>
        </div>
      </div>

      <div class="capture-grid">
        <!-- Sidebar -->
        <aside class="capture-sidebar">
          <div class="panel inner">
            <div class="panel__title">Collections</div>
            <div class="panel__body">
              <form
                method="post"
                action="{{ url_for('capture_set_collections', capture_id=capture.id) }}"
              >
                <div class="col-list">
                  {% for c in collections %}
                    <label class="col-check">
                      <input
                        class="cap-check"
                        type="checkbox"
                        name="collection_ids"
                        value="{{ c.id }}"
                        {% if c.has_it %}checked{% endif %}
                      />
                      {{ c.name }}
                    </label>
                  {% endfor %}
                </div>
                <div style="margin-top: 10px">
                  <button class="btn btn--primary" type="submit">Save</button>
                </div>
              </form>
            </div>
          </div>

          <div class="panel inner">
            <div class="panel__title">Metadata</div>
            <div class="panel__body">
              <div class="kv">
                <div class="k">DOI</div>
                <div class="v">{{ capture.doi or "" }}</div>
              </div>
              <div class="kv">
                <div class="k">Year</div>
                <div class="v">{{ capture.year or "" }}</div>
              </div>
              <div class="kv">
                <div class="k">Container</div>
                <div class="v">{{ capture.container_title or "" }}</div>
              </div>

              {% if meta.published_date_raw %}
                <div class="kv">
                  <div class="k">Published</div>
                  <div class="v">{{ meta.published_date_raw }}</div>
                </div>
              {% endif %}

              {% if meta.keywords %}
                <div class="kv">
                  <div class="k">Keywords</div>
                  <div class="v">{{ meta.keywords | join(", ") }}</div>
                </div>
              {% endif %}
            </div>
          </div>

          <div class="panel inner">
            <div class="panel__title">Artifacts</div>
            <div class="panel__body">
              {% if artifacts and artifacts|length > 0 %}
                <div class="artifacts-grid">
                  {% for a in artifacts %}
                    <a
                      class="artifact-link"
                      href="{{ a.url }}"
                      target="_blank"
                      rel="noopener noreferrer"
                      >{{ a.name }}</a
                    >
                  {% endfor %}
                </div>
              {% else %}
                <div class="muted">No artifacts available.</div>
              {% endif %}
            </div>
          </div>
        </aside>

        <!-- Main -->
        <section class="capture-main">
          <div class="panel inner">
            <div class="panel__title">Parsed text</div>
            <div class="panel__body">
              <details class="details" open>
                <summary>
                  <span>Article body</span>
                  {% if parsed.article.exists %}
                    <span class="details-meta">
                      <a
                        href="{{ parsed.article.url }}"
                        target="_blank"
                        rel="noopener noreferrer"
                        >article.txt</a
                      >
                      · {{ parsed.article.chars }}
                      chars{% if parsed.article.truncated %}(truncated){% endif %}
                    </span>
                  {% endif %}
                </summary>
                <div class="details-body">
                  {% if parsed.article.exists and parsed.article.text %}
                    <pre class="pre">{{ parsed.article.text }}</pre>
                  {% else %}
                    <div class="muted small">
                      No parsed article text available.
                    </div>
                  {% endif %}
                </div>
              </details>

              <details class="details">
                <summary>
                  <span>References</span>
                  {% if parsed.references.exists %}
                    <span class="details-meta">
                      <a
                        href="{{ parsed.references.url }}"
                        target="_blank"
                        rel="noopener noreferrer"
                        >references.txt</a
                      >
                      · {{ parsed.references.chars }}
                      chars{% if parsed.references.truncated %}(truncated){% endif %}
                    </span>
                  {% endif %}
                </summary>
                <div class="details-body">
                  {% if parsed.references.exists and parsed.references.text %}
                    <pre class="pre">{{ parsed.references.text }}</pre>
                  {% else %}
                    <div class="muted small">No references text available.</div>
                  {% endif %}
                </div>
              </details>
            </div>
          </div>

          {% if meta.meta %}
            <div class="panel inner">
              <div class="panel__title">Head meta</div>
              <div class="panel__body">
                <details class="details">
                  <summary>
                    <span>Raw head meta (debug)</span>
                    <span class="details-meta">JSON</span>
                  </summary>
                  <div class="details-body">
                    <pre class="pre">{{ meta.meta | tojson(indent=2) }}</pre>
                  </div>
                </details>
              </div>
            </div>
          {% endif %}
        </section>
      </div>
    </div>
  </div>
{% endblock %}
