{% extends "base.html" %}
{% block title %}Graph · Paperclip{% endblock %}
{% block content %}
  {% if no_run %}
    <div class="panel" style="margin:10px">
      <div class="empty">No graph yet. Use “Run analysis” in the top bar, then come back.</div>
    </div>
  {% else %}
    <div class="panel" style="margin:10px; display:flex; gap:10px; align-items:center">
      <label for="runPick" style="font-weight:700">Run:</label>
      <select id="runPick">
        {% for r in runs %}
          <option value="{{ r.id }}" {% if r.id == selected_id %}selected{% endif %}>{{ r.id }} · {{ r.status }} · {{ r.created_at }}</option>
        {% endfor %}
      </select>
      <div id="runProg" class="muted"></div>
    </div>
    <iframe id="graphFrame" src="{{ embed_url }}"
            style="display:block;width:100%;height:calc(100vh - 140px);border:0;background:#0f141a"></iframe>

    <script>
      (function(){
        const pick  = document.getElementById('runPick');
        const frame = document.getElementById('graphFrame');
        const prog  = document.getElementById('runProg');

        function currentTheme(){ return document.documentElement.getAttribute('data-theme') || 'dark'; }
        function setSrc(id){
          frame.src = "{% url 'analysis_graph_embed' %}?run=" + id + "&theme=" + encodeURIComponent(currentTheme());
        }

        // Only poll the SELECTED run, stop when finished,
        // pause when tab hidden, and slow down to 2s cadence.
        let stop = false, timer = null;
        async function pollOnce(id){
          try{
            const r = await fetch(`/runs/${id}/progress.json`, {cache: 'no-store'});
            if(!r.ok) return false;
            const j = await r.json();
            if (!j.ok) return false;
            if (j.status === "SUCCESS" || j.status === "FAILED"){
              prog.textContent = "";
              return true;
            }
            prog.textContent = `${j.status} ${j.progress}% — ${j.log || ''}`;
            return false;
          }catch(_){ return false; }
        }
        async function loop(){
          if (stop) return;
          if (document.visibilityState !== 'visible'){ timer = setTimeout(loop, 2000); return; }
          const done = await pollOnce(pick.value);
          if (done){ stop = true; return; }
          timer = setTimeout(loop, 2000);
        }

        pick.addEventListener('change', () => { stop = false; prog.textContent = ""; setSrc(pick.value); clearTimeout(timer); loop(); });
        window.addEventListener('pagehide', () => { stop = true; clearTimeout(timer); });

        // kick off
        loop();
      })();
    </script>
  {% endif %}
{% endblock %}
