{% extends "base.html" %}
{% load capture_extras %}
{% block title %}Capture · Paperclip{% endblock %}
{% block content %}
<div class="panel" style="margin:10px">
  <h2 style="margin-top:0">{{ cap.title|default:cap.url }}</h2>
  <div class="muted">
    {{ cap.meta.container_title }} · {{ cap.year|default:"—" }}
    {% if cap.doi %} · <a href="{{ cap.doi|doi_url }}" target="_blank" rel="noopener">{{ cap.doi }}</a>{% endif %}
  </div>

  {% if abs %}
    <div class="panel" style="margin-top:12px">
      <h3 style="margin:0 0 6px 0">Abstract</h3>
      <div>{{ abs }}</div>
    </div>
  {% endif %}

  {% if cap.meta.sections %}
    <div class="panel" style="margin-top:12px">
      <h3 style="margin:0 0 6px 0">Sections</h3>

      <!-- Sticky crumb bar: hidden until scrolled; includes ↑ Top -->
      <div id="pc-crumbs" class="sticky-crumbs is-hidden">
        <div style="display:flex;align-items:center;justify-content:space-between;gap:8px">
          <div id="pc-crumbs-path" aria-label="Current section breadcrumb">Sections</div>
          <a href="#" id="pc-back-top" class="chip" title="Back to top">↑ Top</a>
        </div>
      </div>

      <div class="sec-list" id="pc-sections">
        {% for s in cap.meta.sections %}
          {% include "captures/_section_tree.html" with s=s %}
        {% endfor %}
      </div>
    </div>
  {% endif %}

  <h3>Artifacts</h3>
  <ul>
    <li><a href="{% url 'artifact' cap.id 'doc.json' %}" target="_blank">doc.json</a> <span class="muted">— canonical, full</span></li>
    <li><a href="{% url 'artifact' cap.id 'view.json' %}" target="_blank">view.json</a> <span class="muted">— reduced, UI-friendly</span></li>
    <li><a href="{% url 'artifact' cap.id 'page.html' %}" target="_blank">page.html</a></li>
    {% if content %}<li><a href="{% url 'artifact' cap.id 'content.html' %}" target="_blank">content.html</a></li>{% endif %}
  </ul>

  <div style="display:flex;align-items:center;gap:10px">
    <h3 style="margin:0">References ({{ refs|length }})</h3>
    <form method="post" action="{% url 'capture_enrich_refs' cap.id %}">
      {% csrf_token %}
      <button class="btn" type="submit">Enrich references (Crossref)</button>
    </form>
  </div>

  <div class="ref-grid">
    {% for r in refs %}
      <div class="ref-card">
        <div class="ref-num">{{ forloop.counter }}</div>
        <div class="ref-body">
          <div class="ref-text">
            {% if r.apa %}{{ r.apa }}{% else %}{{ r.raw|default:r.title }}{% endif %}
          </div>
          <div class="ref-meta">
            {% if r.container_title %}<span class="chip chip--tag">{{ r.container_title }}</span>{% endif %}
            {% if r.issued_year %}<span class="chip chip--tag">{{ r.issued_year }}</span>{% endif %}
            {% if r.doi %}
              <a class="chip chip--doi" href="{{ r.doi|doi_url }}" target="_blank" rel="noopener">
                DOI:&nbsp;<span class="mono">{{ r.doi }}</span>
              </a>
            {% endif %}
          </div>
        </div>
      </div>
    {% empty %}
      <div class="empty">None.</div>
    {% endfor %}
  </div>

  {% if content %}
    <details class="sec" style="margin-top:12px" id="pc-debug">
      <summary class="sec__summary">Debug: HTML content snapshot</summary>
      <div class="sec__body">
        <div class="panel" style="background:#0f1216;border:1px solid #273244;overflow:auto">
          {{ content|safe }}
        </div>
      </div>
    </details>
  {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script>
(function() {
  const crumbsEl = document.getElementById('pc-crumbs');
  const pathEl   = document.getElementById('pc-crumbs-path');
  const secRoot  = document.getElementById('pc-sections');
  const backTop  = document.getElementById('pc-back-top');
  if (!crumbsEl || !secRoot || !pathEl) return;

  // --- dynamic header offset (top nav + crumbs height + small padding) ---
  function headerOffset(){
    const nav = document.querySelector('.nav');
    const navH = nav ? nav.getBoundingClientRect().height : 0;
    // scrollHeight still reflects full height even when the crumbs are visually collapsed
    const crumbH = crumbsEl ? Math.max(crumbsEl.scrollHeight || 0, crumbsEl.getBoundingClientRect().height || 0) : 0;
    return Math.round(navH + crumbH + 12);
  }

  let thresholdY = 0;

  // Give every summary a stable id we can link to
  const summaries = Array.from(secRoot.querySelectorAll('.sec__summary'));
  summaries.forEach((el, i) => { el.dataset.sid = String(i + 1); el.id ||= `pc-sec-${i+1}`; });

  // Expand all 'details' so headings exist for scroll/visibility math
  secRoot.querySelectorAll('details.sec').forEach(d => d.open = true);

  function computeThreshold(){
    const r = secRoot.getBoundingClientRect();
    thresholdY = window.scrollY + r.top - headerOffset();
  }
  computeThreshold();

  function updateVisibility(){
    const show = window.scrollY > thresholdY;
    crumbsEl.classList.toggle('is-hidden', !show);
  }

  function computeCurrentSummary() {
    let best = null, bestDist = Infinity;
    const off = headerOffset();
    for (const s of summaries) {
      const r = s.getBoundingClientRect();
      const dist = Math.abs(r.top - off);
      if (dist < bestDist) { bestDist = dist; best = s; }
    }
    return best;
  }

  function nodeChain(node){
    const chain = [];
    let cur = node;
    while (cur) {
      if (cur.classList && cur.classList.contains('sec__summary')) {
        chain.unshift(cur);
        const parentSec = cur.closest('.sec')?.parentElement?.closest('.sec');
        cur = parentSec ? parentSec.querySelector(':scope > .sec__summary') : null;
      } else {
        cur = cur.parentElement;
      }
    }
    return chain;
  }

  function escapeHtml(s){
    return (s || '').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  }

  function renderCrumbs() {
    const cur = computeCurrentSummary();
    const chain = cur ? nodeChain(cur) : [];
    pathEl.innerHTML = chain.map(el =>
      `<a class="crumb" href="#pc-sec-${el.dataset.sid}" data-target="${el.dataset.sid}" title="${escapeHtml(el.textContent.trim())}">${escapeHtml(el.textContent.trim())}</a>`
    ).join('<span class="crumb-sep">›</span>');
  }

  // Click to jump to that section (and make sure ancestors are open)
  pathEl.addEventListener('click', (e) => {
    const a = e.target.closest('a.crumb'); if (!a) return;
    e.preventDefault();
    const id = a.getAttribute('data-target');
    const target = secRoot.querySelector(`.sec__summary[data-sid="${id}"]`);
    if (!target) return;

    // ensure ancestors are open
    let d = target.closest('details.sec');
    while (d) { d.open = true; d = d.parentElement?.closest('details.sec'); }

    const y = window.scrollY + target.getBoundingClientRect().top - (headerOffset() + 4);
    window.scrollTo({ top: y, behavior: 'smooth' });

    target.classList.add('flash');
    setTimeout(() => target.classList.remove('flash'), 500);
  });

  // Back-to-top
  backTop?.addEventListener('click', (e) => {
    e.preventDefault();
    window.scrollTo({ top: 0, behavior: 'smooth' });
  });

  document.addEventListener('scroll', () => { updateVisibility(); renderCrumbs(); }, { passive:true });
  window.addEventListener('resize', () => { computeThreshold(); updateVisibility(); renderCrumbs(); }, { passive:true });

  // initial
  updateVisibility(); renderCrumbs();
})();
</script>
{% endblock %}
