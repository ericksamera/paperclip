{% extends "base.html" %}
{% load capture_extras %}

{% block title %}Capture · Paperclip{% endblock %}

{% block content %}
<div class="panel" style="margin:10px">
  <h2 style="margin-top:0">{{ cap.title|default:cap.url }}</h2>

  {# Authors: slightly emphasized, "First M Last, ..." #}
  {% if authors_line %}
    <div style="margin:6px 0 6px 0; font-size:15px; font-weight:600; letter-spacing:.01em">
      {{ authors_line }}
    </div>
  {% endif %}

  <div class="muted">
    {{ cap.meta.container_title }} · {{ cap.year|default:"—" }}
    {% if cap.doi %} · <a href="{{ cap.doi|doi_url }}" target="_blank" rel="noopener">{{ cap.doi }}</a>{% endif %}
  </div>

  {% if abs %}
    <div class="panel" style="margin-top:12px">
      <h3 style="margin:0 0 6px 0">Abstract</h3>
      <div>{{ abs }}</div>
    </div>
  {% endif %}

  {% if sections %}
    <div class="panel" style="margin-top:12px">
      <h3 style="margin:0 0 6px 0">Sections</h3>

      <div id="pc-crumbs" class="sticky-crumbs is-hidden">
        <div style="display:flex;align-items:center;justify-content:space-between;gap:8px">
          <div id="pc-crumbs-path" aria-label="Current section breadcrumb">Sections</div>
          <a href="#" id="pc-back-top" class="chip" title="Back to top">↑ Top</a>
        </div>
      </div>

      <div class="sec-list" id="pc-sections">
        {% for s in sections %}
          {% include "captures/_section_tree.html" with s=s %}
        {% endfor %}
      </div>
    </div>
  {% endif %}

  <h3>Artifacts</h3>
  <ul>
    <li><a href="{% url 'artifact' cap.id 'server_parsed.json' %}">server_parsed.json</a> — canonical, full</li>
    <li><a href="{% url 'artifact' cap.id 'server_output_reduced.json' %}">server_output_reduced.json</a> — reduced, UI-friendly</li>
    <li><a href="{% url 'artifact' cap.id 'page.html' %}">page.html</a></li>
    <li><a href="{% url 'artifact' cap.id 'content.html' %}">content.html</a></li>
  </ul>
  <p class="muted" style="margin:.25rem 0 0">
    Older captures on <code>doc.json</code>/<code>view.json</code> still open via fallback.
  </p>

  <div style="display:flex;align-items:center;gap:10px">
    <h3 style="margin:0">References ({{ refs|length }})</h3>
    <form method="post" action="{% url 'capture_enrich_refs' cap.id %}">
      {% csrf_token %}
      <button class="btn" type="submit">Enrich references (Crossref)</button>
    </form>
  </div>

  <div class="ref-grid">
    {% for r in refs %}
      <div class="ref-card">
        <div class="ref-num">{{ forloop.counter }}</div>
        <div class="ref-body">
          <div class="ref-text">
            {% if r.apa %}{{ r.apa }}{% else %}{{ r.raw|default:r.title }}{% endif %}
          </div>
          <div class="ref-meta">
            {% if r.container_title %}<span class="chip chip--tag">{{ r.container_title }}</span>{% endif %}
            {% if r.issued_year %}<span class="chip chip--tag">{{ r.issued_year }}</span>{% endif %}
            {% if r.doi %}
              <a class="chip chip--doi" href="{{ r.doi|doi_url }}" target="_blank" rel="noopener">
                DOI:&nbsp;<span class="mono">{{ r.doi }}</span>
              </a>
            {% endif %}
          </div>
        </div>
      </div>
    {% empty %}
      <div class="empty">None.</div>
    {% endfor %}
  </div>

  {% if content %}
    <details class="sec" style="margin-top:12px" id="pc-debug">
      <summary class="sec__summary">Debug: HTML content snapshot</summary>
      <div class="sec__body">
        <div class="panel" style="background:#0f1216;border:1px solid #273244;overflow:auto">
          {{ content|safe }}
        </div>
      </div>
    </details>
  {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script>
(function() {
  const crumbsEl = document.getElementById('pc-crumbs');
  const pathEl   = document.getElementById('pc-crumbs-path');
  const secRoot  = document.getElementById('pc-sections');
  const backTop  = document.getElementById('pc-back-top');
  if (!crumbsEl || !secRoot || !pathEl) return;

  // Assign stable ids; keep details open so layout math is accurate
  const summaries = Array.from(secRoot.querySelectorAll('.sec__summary'));
  summaries.forEach((el, i) => { el.dataset.sid = String(i + 1); if (!el.id) el.id = `pc-sec-${i+1}`; });
  secRoot.querySelectorAll('details.sec').forEach(d => d.open = true);

  // Measurements
  const navEl = document.querySelector('.nav');
  const navH = () => (navEl ? Math.round(navEl.getBoundingClientRect().height) : 0);

  let _sectionsTopAbs = null;
  function sectionsTopAbs() {
    if (_sectionsTopAbs == null) {
      const r = secRoot.getBoundingClientRect();
      _sectionsTopAbs = window.scrollY + r.top;
    }
    return _sectionsTopAbs;
  }
  function resetSectionsTop() { _sectionsTopAbs = null; }

  function updateVisibility(){
    const show = (window.scrollY + navH() + 8) >= sectionsTopAbs();
    crumbsEl.classList.toggle('is-hidden', !show);
  }

  function escapeHtml(s){ return (s || '').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

  function chainFor(sum){
    const chain = [];
    let cur = sum;
    while (cur) {
      if (cur.classList && cur.classList.contains('sec__summary')) {
        chain.unshift(cur);
        const d = cur.closest('.sec');
        const outer = d?.parentElement?.closest('.sec');
        cur = outer ? outer.querySelector(':scope > .sec__summary') : null;
      } else {
        cur = cur.parentElement;
      }
    }
    return chain;
  }

  function renderCrumbs(sum){
    const chain = chainFor(sum);
    if (!chain.length) { pathEl.textContent = 'Sections'; return; }
    pathEl.innerHTML = chain.map(el => {
      const label = (el.textContent || '').trim().replace(/\s+/g, ' ');
      return `<a class="crumb" href="#${el.id}" data-target-id="${el.id}" title="${escapeHtml(label)}">${escapeHtml(label)}</a>`;
    }).join('<span class="crumb-sep">›</span>');
  }

  // Active-section tracking (absolute coords)
  let lastIdx = -1;
  function stickyEdgeAbs(){
    const ch = crumbsEl.classList.contains('is-hidden') ? 0 : Math.round(crumbsEl.getBoundingClientRect().height);
    return window.scrollY + navH() + ch + 8;
  }
  function updateActive(){
    const edge = stickyEdgeAbs();
    let idx = 0;
    for (let i = 0; i < summaries.length; i++) {
      const topAbs = window.scrollY + summaries[i].getBoundingClientRect().top;
      if (topAbs <= edge + 0.5) idx = i; else break;
    }
    if (idx !== lastIdx) { lastIdx = idx; renderCrumbs(summaries[idx]); }
  }

  // Crumb → smooth scroll to exact section top (accounting for sticky offset)
  pathEl.addEventListener('click', (e) => {
    const a = e.target.closest('a.crumb'); if (!a) return;
    e.preventDefault();
    const targetId = a.getAttribute('data-target-id') || a.getAttribute('href')?.slice(1);
    const target = targetId ? document.getElementById(targetId) : null;
    if (!target) return;

    // Ensure ancestors are open, then measure on next paint
    let d = target.closest('details.sec');
    while (d) { d.open = true; d = d.parentElement?.closest('details.sec'); }

    requestAnimationFrame(() => {
      const ch = crumbsEl.classList.contains('is-hidden') ? 0 : Math.round(crumbsEl.getBoundingClientRect().height);
      const offset = navH() + ch + 6;
      const absTop = window.scrollY + target.getBoundingClientRect().top;
      const dest = Math.max(0, absTop - offset);
      window.scrollTo({ top: dest, behavior: 'smooth' });
      try { history.replaceState(null, "", "#" + target.id); } catch (_) {}
      target.classList.add('flash'); setTimeout(() => target.classList.remove('flash'), 500);
    });
  });

  backTop?.addEventListener('click', (e) => { e.preventDefault(); window.scrollTo({ top: 0, behavior: 'smooth' }); });

  // Throttled loop
  let raf = null;
  function tick(){ if (raf) return; raf = requestAnimationFrame(() => { raf = null; updateVisibility(); updateActive(); }); }
  document.addEventListener('scroll', tick, { passive:true });
  window.addEventListener('resize', () => { resetSectionsTop(); tick(); }, { passive:true });

  // initial
  resetSectionsTop();
  tick();
})();
</script>
{% endblock %}
