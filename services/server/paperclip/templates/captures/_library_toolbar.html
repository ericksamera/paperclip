{% load qs capture_extras %}

<!-- Toolbar -->
<div class="z-toolbar">

  <form class="z-search" method="get" action=".">
    <input class="z-input" type="text" name="q" placeholder="Search title / URL…" value="{{ selected.q }}">
    <input type="hidden" name="search" value="{{ selected.search }}">
    {% if selected.year %}<input type="hidden" name="year" value="{{ selected.year }}">{% endif %}
    {% if selected.journal %}<input type="hidden" name="journal" value="{{ selected.journal }}">{% endif %}
    {% if selected.site %}<input type="hidden" name="site" value="{{ selected.site }}">{% endif %}
    {% if selected.col %}<input type="hidden" name="col" value="{{ selected.col }}">{% endif %}

    <span class="z-mode">
      <span class="z-mode-chips" role="group" aria-label="Search mode">
        <button type="button" class="chip z-mode-chip {% if not selected.search %}active{% endif %}" data-mode="">Text</button>
        <button type="button" class="chip z-mode-chip {% if selected.search == 'semantic' %}active{% endif %}" data-mode="semantic">Semantic</button>
        <button type="button" class="chip z-mode-chip {% if selected.search == 'hybrid' %}active{% endif %}" data-mode="hybrid">Hybrid</button>
      </span>
      <span class="z-mode-hint muted">Text = exact; Semantic = meaning; Hybrid = both</span>
    </span>

    <button class="btn" type="submit">Search</button>
    <a class="btn z-clear" href="{% url 'library' %}">Clear filters</a>
  </form>

  <div class="z-actions">
    <form id="pc-bulk-form" method="post" action="{% url 'capture_bulk_delete' %}">
      {% csrf_token %}
      <button id="pc-bulk-delete" class="btn btn--danger" type="button" disabled>Delete selected</button>
    </form>

    <!-- Optional: assign to collection (kept for now; safe to remove later) -->
    <div style="display:flex;gap:6px;align-items:center">
      <select id="pc-assign-select" class="z-input" style="min-width:18ch">
        <option value="">— Choose collection —</option>
        {% for c in collections %}
          <option value="{{ c.id }}">{{ c.name }}</option>
        {% endfor %}
      </select>
      <button id="pc-assign-add" class="btn btn--primary" type="button">Add to</button>
      <button id="pc-assign-remove" class="btn" type="button">Remove</button>
    </div>

    {% if selected.col %}
      <a class="btn" href="{% url 'collection_download_views' selected.col %}">Download views</a>
    {% else %}
      <a class="btn" href="{% url 'collection_download_views' 'all' %}">Download views</a>
    {% endif %}
    <a class="btn" href="{% url 'dedup_review' %}">Dedup review</a>
    <a class="btn" href="{% url 'capture_export' %}?{{ current_params.urlencode }}">Export CSV</a>

    <button id="z-toggle-left" class="btn" type="button" title="Toggle sidebar">Sidebar ⇆</button>
    <button id="z-toggle-right" class="btn" type="button" title="Toggle info panel">Info ⇆</button>

    <button id="pc-cols-toggle" class="btn" type="button" title="Edit visible columns & widths">Columns</button>
  </div>
</div>

<!-- Columns editor popover -->
<div id="pc-cols-panel" class="panel">
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
    <strong>Columns</strong>
    <button id="pc-cols-close" class="btn" type="button" aria-label="Close">✕</button>
  </div>

  <div class="row">
    <em class="muted">Show / hide</em>
    <div class="grid">
      <label><input type="checkbox" data-col-toggle="title" disabled checked> Title (always on)</label><span></span>
      <label><input type="checkbox" data-col-toggle="authors"> Authors</label><span></span>
      <label><input type="checkbox" data-col-toggle="year"> Year</label><span></span>
      <label><input type="checkbox" data-col-toggle="journal"> Journal</label><span></span>
      <label><input type="checkbox" data-col-toggle="doi"> DOI</label><span></span>
      <label><input type="checkbox" data-col-toggle="added"> Added</label><span></span>
      <label><input type="checkbox" data-col-toggle="refs"> Refs</label><span></span>
    </div>
  </div>

  <div class="row" style="margin-top:10px">
    <em class="muted">Widths (ch units; leave blank = auto)</em>
    <div class="grid">
      <label>Authors</label><input class="z-input" data-col-width="authors" placeholder="e.g. 16">
      <label>Year</label><input class="z-input" data-col-width="year" placeholder="e.g. 6">
      <label>Journal</label><input class="z-input" data-col-width="journal" placeholder="e.g. 24">
      <label>DOI</label><input class="z-input" data-col-width="doi" placeholder="e.g. 24">
      <label>Added</label><input class="z-input" data-col-width="added" placeholder="e.g. 10">
      <label>Refs</label><input class="z-input" data-col-width="refs" placeholder="e.g. 6">
    </div>
  </div>

  <div class="row" style="display:flex;gap:8px">
    <button id="pc-cols-reset" class="btn" type="button">Reset defaults</button>
    <span class="muted">Saved automatically</span>
  </div>
</div>
