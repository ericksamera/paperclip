{% load qs %}

<!-- Toolbar -->
<div class="z-toolbar">

  <form class="z-search" method="get" action=".">
    <input class="z-input" type="text" name="q" placeholder="Search title / URL…" value="{{ selected.q }}">
    <input type="hidden" name="search" value="{{ selected.search }}">
    {% if selected.year %}<input type="hidden" name="year" value="{{ selected.year }}">{% endif %}
    {% if selected.journal %}<input type="hidden" name="journal" value="{{ selected.journal }}">{% endif %}
    {% if selected.site %}<input type="hidden" name="site" value="{{ selected.site }}">{% endif %}
    {% if selected.col %}<input type="hidden" name="col" value="{{ selected.col }}">{% endif %}

    <span class="z-mode">
      <!-- Segmented control -->
      <span class="segmented" role="group" aria-label="Search mode">
        <button
          type="button"
          class="seg-btn z-mode-chip {% if not selected.search %}active{% endif %}"
          data-mode=""
          aria-pressed="{% if not selected.search %}true{% else %}false{% endif %}">
          Text
        </button>
        <button
          type="button"
          class="seg-btn z-mode-chip {% if selected.search == 'semantic' %}active{% endif %}"
          data-mode="semantic"
          aria-pressed="{% if selected.search == 'semantic' %}true{% else %}false{% endif %}">
          Semantic
        </button>
        <button
          type="button"
          class="seg-btn z-mode-chip {% if selected.search == 'hybrid' %}active{% endif %}"
          data-mode="hybrid"
          aria-pressed="{% if selected.search == 'hybrid' %}true{% else %}false{% endif %}">
          Hybrid
        </button>
      </span>

      <!-- ⓘ icon with native tooltip (renamed to avoid clash with the right pane .z-info) -->
      <button
        type="button"
        class="z-mode-info"
        title="Text = exact; Semantic = meaning; Hybrid = both"
        aria-label="Explain search modes">ⓘ</button>
    </span>

    <button class="btn" type="submit">Search</button>
    <a class="btn z-clear" href="{% url 'library' %}">Clear filters</a>
  </form>

  <div class="z-actions">
    {# Hidden “ghost” container keeps legacy controls in the DOM for scripts, but removes them from the UI #}
    <div id="pc-ghost-controls" style="display:none" aria-hidden="true">
      <form id="pc-bulk-form" method="post" action="{% url 'capture_bulk_delete' %}">
        {% csrf_token %}
        <button id="pc-bulk-delete" class="btn btn--danger" type="button" disabled>Delete selected</button>
      </form>

      <!-- Optional: assign to collection (kept functional but hidden) -->
      <div style="display:flex;gap:6px;align-items:center">
        <select id="pc-assign-select" class="z-input" style="min-width:18ch">
          <option value="">— Choose collection —</option>
          {% for c in collections %}
            <option value="{{ c.id }}">{{ c.name }}</option>
          {% endfor %}
        </select>
        <button id="pc-assign-add" class="btn btn--primary" type="button">Add to</button>
        <button id="pc-assign-remove" class="btn" type="button">Remove</button>
      </div>
    </div>

    {% if selected.col %}
      <a class="btn" href="{% url 'collection_download_views' selected.col %}">Download views</a>
    {% else %}
      <a class="btn" href="{% url 'collection_download_views' 'all' %}">Download views</a>
    {% endif %}
    <a class="btn" href="{% url 'dedup_review' %}">Dedup review</a>
    <a class="btn" href="{% url 'capture_export' %}?{{ current_params.urlencode }}">Export CSV</a>

    <button id="z-toggle-left" class="btn" type="button" title="Toggle sidebar">Sidebar ⇆</button>
    <button id="z-toggle-right" class="btn" type="button" title="Toggle info panel">Info ⇆</button>
  </div>
</div>

<!-- Columns drawer (modal overlay) -->
<div id="pc-cols-drawer" class="pc-drawer" aria-hidden="true">
  <div class="backdrop" id="pc-cols-drawer-backdrop" tabindex="-1" aria-hidden="true"></div>

  <aside class="panel" role="dialog" aria-modal="true" aria-label="Columns">
    <div class="header" style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
      <strong>Columns</strong>
      <button id="pc-cols-close" class="btn" type="button" aria-label="Close">✕</button>
    </div>

    <div class="row">
      <em class="muted">Show / hide &amp; drag to reorder</em>
      <ul id="pc-cols-list" class="pc-cols-list" aria-label="Columns order and visibility">
        {# Rows are injected by JS to reflect saved order; keep server markup minimal #}
      </ul>
    </div>

    <div class="row" style="display:flex;gap:8px;align-items:center">
      <button id="pc-cols-reset" class="btn" type="button">Reset defaults</button>
      <span class="muted">Saved automatically</span>
    </div>
  </aside>
</div>
