{% extends "base.html" %}
{% load static staticv %}

{% block title %}Q&A Workspace — {{ collection.name }} · Paperclip{% endblock %}

{% block content %}

<style>
/* --- QAW wireframe (scoped) --- */
#pc-qaw{
  --pc-card: color-mix(in oklab, var(--panel) 96%, var(--fg) 4%);
  --pc-elev: var(--panel);
  --pc-soft: color-mix(in oklab, var(--panel) 90%, var(--fg) 10%);
  --pc-muted: var(--muted);
  --pc-text: var(--fg);
  --pc-border: var(--line);
  --pc-accent: var(--accent);
  --pc-accent-quiet: color-mix(in oklab, var(--accent) 22%, transparent);
  --pc-good:#33c48f; --pc-warn:#f5b44c; --pc-danger:#ff5d78;
  --pc-shadow: var(--shadow);
}
#pc-qaw a{ color:var(--pc-accent); text-decoration:none }
#pc-qaw a:hover{ text-decoration:underline }

.pc-topbar{display:flex;align-items:center;gap:10px;margin-bottom:10px}
.pc-topbar .crumb{opacity:.85}

/* Sticky Ask bar (hidden in splash/empty state) */
.pc-askbar{position:sticky; top:56px; z-index:12; background:var(--pc-elev); border:1px solid var(--pc-border); border-radius:12px; padding:10px}
.pc-ask-input{display:flex; gap:10px; align-items:center; background:var(--pc-card); border:1px solid var(--pc-border); border-radius:14px; padding:10px 12px}
.pc-ask-input input{flex:1; border:0; outline:0; background:transparent; color:var(--pc-text); font-size:15px}
.pc-seg{display:inline-flex; background:var(--pc-soft); border:1px solid var(--pc-border); border-radius:10px; padding:2px}
.pc-seg button{border:0;background:transparent;padding:6px 10px;border-radius:8px;color:var(--pc-muted);font-weight:700;cursor:pointer}
.pc-seg button[aria-pressed="true"]{background:var(--pc-card);color:var(--pc-text);box-shadow:var(--pc-shadow)}
.pc-runbtn{border:0;border-radius:12px;padding:10px 14px;font-weight:800;background:var(--pc-accent);color:#fff;cursor:pointer}

/* 3-panel grid (normal workspace) */
.pc-grid{display:grid; grid-template-columns: 280px 1fr 320px; gap:12px; margin-top:12px}
@media (max-width: 1160px){ .pc-grid{ grid-template-columns: 240px 1fr } .pc-right{ display:none } }
@media (max-width: 860px){ .pc-grid{ grid-template-columns: 1fr } .pc-left{ order:2 } .pc-center{ order:1 } }
.pc-card{ background:var(--pc-card); border:1px solid var(--pc-border); border-radius:14px; box-shadow:var(--pc-shadow) }
.pc-pad{ padding:12px }

/* Ledger */
.pc-list{ list-style:none; padding:0; margin:0; display:flex; flex-direction:column; gap:8px }
.pc-qcard{ background:var(--pc-soft); border:1px solid var(--pc-border); border-radius:12px; padding:10px; cursor:pointer }
.pc-qcard:hover{ border-color:var(--pc-accent) } .pc-qcard[aria-selected="true"]{ outline:2px solid var(--pc-accent-quiet) }
.pc-qtitle{ font-weight:900; margin:0 0 4px 0; font-size:14px }
.pc-qsub{ color:var(--pc-muted); font-size:12px; margin:0 0 8px 0 }
.pc-chips{ display:flex; gap:6px; flex-wrap:wrap } .pc-chip{ font-size:11px; padding:3px 8px; border-radius:999px; background:transparent; border:1px solid var(--pc-border); color:var(--pc-muted) }

/* Answer canvas */
.pc-sections{ display:flex; flex-direction:column; gap:12px }
.pc-section .hd{ font-weight:900; margin-bottom:6px }
.pc-bullets{ margin:0; padding-left:18px }
.pc-sources{ display:grid; grid-template-columns:1fr 1fr; gap:10px } @media (max-width: 720px){ .pc-sources{ grid-template-columns:1fr } }
.pc-source{ background:var(--pc-soft); border:1px solid var(--pc-border); border-radius:12px; padding:8px 10px }

/* Mini bars */
.pc-bars{ display:flex; align-items:flex-end; gap:4px; height:54px; padding:6px; background:var(--pc-soft); border:1px solid var(--pc-border); border-radius:10px }
.pc-bars div{ width:8px; background:var(--pc-accent); border-radius:4px 4px 0 0; opacity:.85 }

/* SPLASH (centered like ChatGPT) */
#pc-splash{ display:none }
#pc-qaw.is-empty .pc-askbar { display:none }          /* hide sticky bar */
#pc-qaw.is-empty .pc-grid  { display:none }           /* hide workspace grid */
#pc-qaw.is-empty #pc-splash{ display:grid }           /* show centered hero */

#pc-splash{
  min-height: calc(100vh - 160px);                   /* viewport-ish, adjust if your top nav is taller */
  place-items: center;
}
.pc-hero-center{
  width: 100%;
  max-width: 860px;
  margin: 0 auto;
  display: grid;
  gap: 14px;
  justify-items: stretch;
}
.pc-hero-title{
  text-align:center;
  font-weight:900;
  letter-spacing:.2px;
  font-size: clamp(28px, 4vw, 40px);
}
.pc-hero-sub{ text-align:center; color:var(--pc-muted) }

/* larger input block for hero */
.pc-hero-input{
  display:flex; align-items:center; gap:12px;
  background:var(--pc-card);
  border:1px solid var(--pc-border);
  border-radius:18px; padding:14px 16px;
  box-shadow: var(--pc-shadow);
}
.pc-hero-input input{
  flex:1; border:0; outline:0; background:transparent; color:var(--pc-text);
  font-size: clamp(15px, 1.6vw, 18px);
}
.pc-hero-actions{ display:flex; gap:10px; align-items:center; justify-content:flex-end }
.pc-suggest{ display:flex; gap:8px; flex-wrap:wrap; justify-content:center }
.pc-suggest .pc-chip{ cursor:pointer; background:color-mix(in oklab, var(--pc-accent) 14%, transparent); color:var(--pc-text) }

/* Utilities */
.muted{ color:var(--pc-muted) }
.skel{ position:relative; overflow:hidden; background:linear-gradient(90deg,var(--pc-soft),var(--pc-card),var(--pc-soft)); background-size:200% 100%; animation:shimmer 1.3s infinite linear; border-radius:10px; height:12px }
@keyframes shimmer{0%{background-position:200% 0}100%{background-position:-200% 0}}
</style>

<div class="container full-bleed" id="pc-qaw">
  <!-- Top crumbs/actions -->
  <div class="pc-topbar">
    <a class="btn" href="{% url 'library' %}">← Back to Library</a>
    <span class="crumb muted">Collection:</span>
    <strong>{{ collection.name }}</strong>
    <span class="crumb muted">·</span>
    <a class="btn" href="{% url 'collection_dashboard' collection.id %}">Dashboard</a>
    <a class="btn" href="{% url 'analysis_graph' %}">Open Graph</a>
    <span class="crumb" style="margin-left:auto;opacity:.75">Q&A Workspace</span>
  </div>

  <!-- SPLASH hero (full-page centered) -->
  <section id="pc-splash" aria-live="polite">
    <div class="pc-hero-center">
      <div class="pc-hero-title">What do you want to ask <span style="opacity:.9">“{{ collection.name }}”</span>?</div>
      <div class="pc-hero-sub">Type a question and press <kbd>Enter</kbd> to begin.</div>
      <div class="pc-hero-input">
        <svg width="20" height="20" viewBox="0 0 24 24" class="muted" aria-hidden="true"><path fill="currentColor" d="M10 4a6 6 0 1 1 0 12a6 6 0 0 1 0-12m0-2a8 8 0 1 0 4.9 14.32l4.4 4.4l1.4-1.42l-4.39-4.39A8 8 0 0 0 10 2"></path></svg>
        <input id="pc-ask-hero" placeholder="e.g., What major disagreements exist about X?">
        <div class="pc-seg" role="group" aria-label="Search method (splash)">
          <button class="pc-seg-btn" data-method="text" aria-pressed="false">Text</button>
          <button class="pc-seg-btn" data-method="semantic" aria-pressed="false">Semantic</button>
          <button class="pc-seg-btn" data-method="hybrid" aria-pressed="true">Hybrid</button>
        </div>
        <button id="pc-run-hero" class="pc-runbtn">Ask</button>
      </div>
      <div class="pc-suggest">
        <span class="pc-chip" data-suggest="What’s the consensus on {topic}?">Consensus on <em>{topic}</em></span>
        <span class="pc-chip" data-suggest="What major disagreements exist about {topic}?">Disagreements</span>
        <span class="pc-chip" data-suggest="Summarize methods used across these papers about {topic}.">Methods</span>
        <span class="pc-chip" data-suggest="Give a timeline of key findings on {topic} by year.">Timeline</span>
        <span class="pc-chip" data-suggest="What open problems are suggested by these papers about {topic}?">Open problems</span>
        <span class="pc-chip" data-suggest="Compare {A} vs {B} interventions across these papers.">Compare A vs B</span>
      </div>
    </div>
  </section>

  <!-- Sticky Ask bar (visible after first question exists) -->
  <div class="pc-askbar">
    <div class="pc-ask-input">
      <svg width="18" height="18" viewBox="0 0 24 24" class="muted" aria-hidden="true"><path fill="currentColor" d="M10 4a6 6 0 1 1 0 12a6 6 0 0 1 0-12m0-2a8 8 0 1 0 4.9 14.32l4.4 4.4l1.4-1.42l-4.39-4.39A8 8 0 0 0 10 2"></path></svg>
      <input id="pc-ask" placeholder="Ask “{{ collection.name }}”… e.g., What do these papers agree on about X?">
      <div class="pc-seg" role="group" aria-label="Search method">
        <button class="pc-seg-btn" data-method="text" aria-pressed="false" title="Text = exact keyword match">Text</button>
        <button class="pc-seg-btn" data-method="semantic" aria-pressed="false" title="Semantic = vector search">Semantic</button>
        <button class="pc-seg-btn" data-method="hybrid" aria-pressed="true" title="Hybrid = best of both">Hybrid</button>
      </div>
      <button id="pc-run-top" class="pc-runbtn">Run</button>
    </div>
  </div>

  <!-- 3-panel layout (hidden in splash) -->
  <div class="pc-grid">
    <!-- Left: Question ledger -->
    <aside class="pc-left">
      <div class="pc-card pc-pad">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px">
          <div style="font-weight:900">Questions</div>
          <div style="display:flex;gap:8px">
            <button id="pc-new-q" class="btn">New</button>
            <button id="pc-monitor-toggle" class="btn" aria-pressed="false" title="Auto-rerun/notify">Monitor</button>
          </div>
        </div>
        <input id="pc-query-filter" class="btn" style="width:100%; text-align:left" placeholder="Filter questions…">
        <ul id="pc-q-list" class="pc-list" aria-label="Saved questions"></ul>
      </div>
    </aside>

    <!-- Center: Answer canvas -->
    <section class="pc-center">
      <article id="pc-answer" class="pc-card pc-pad" aria-live="polite">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px">
          <h1 id="pc-answer-title" style="margin:0;font-size:18px;font-weight:900">—</h1>
          <div style="display:flex;gap:8px;align-items:center">
            <span id="pc-status-chip" class="pc-chip">Draft</span>
            <span id="pc-delta-chip" class="pc-chip muted" hidden>Δ 0</span>
            <button id="pc-compare" class="btn">Compare…</button>
            <button id="pc-share" class="btn">Share</button>
            <button id="pc-rerun" class="pc-runbtn">Rerun</button>
          </div>
        </div>

        <div class="pc-sections">
          <section class="pc-section">
            <div class="hd">Executive summary</div>
            <div id="pc-summary" class="space-y-8"></div>
          </section>

          <section class="pc-section">
            <div class="hd">Agreements</div>
            <ul id="pc-agree" class="pc-bullets"></ul>
          </section>

          <section class="pc-section">
            <div class="hd">Disagreements</div>
            <ul id="pc-disagree" class="pc-bullets"></ul>
          </section>

          <section class="pc-section">
            <div class="hd">Gaps & What’s missing</div>
            <ul id="pc-gaps" class="pc-bullets"></ul>
          </section>

          <section class="pc-section">
            <div class="hd">Coverage</div>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:8px">
              <div>
                <div class="muted" style="font-size:12px;margin-bottom:4px">By year</div>
                <div id="pc-yearbars" class="pc-bars"></div>
              </div>
              <div>
                <div class="muted" style="font-size:12px;margin-bottom:4px">By cluster</div>
                <div id="pc-clusterbars" class="pc-bars"></div>
              </div>
            </div>
          </section>

          <section class="pc-section">
            <div class="hd">Sources</div>
            <div id="pc-sources" class="pc-sources"></div>
          </section>

          <section class="pc-section">
            <div class="hd">History</div>
            <div id="pc-history" class="muted">No runs yet</div>
          </section>
        </div>
      </article>
    </section>

    <!-- Right: scope & method controls -->
    <aside class="pc-right">
      <div class="pc-card pc-pad">
        <div style="font-weight:900;margin-bottom:8px">Scope</div>
        <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px">
          <input id="pc-year-range" class="btn" style="width:100%; text-align:left" placeholder="Years: 2000–2025" value="2000–2025">
          <button id="pc-lock-scope" class="btn" aria-pressed="false" title="Lock scope for follow-ups">Lock</button>
        </div>
        <div id="pc-scope-chips" class="pc-chips"><span class="pc-chip">cluster: genomics</span></div>

        <div style="font-weight:900;margin:12px 0 8px">Method</div>
        <div class="pc-seg" role="group" aria-label="Search method (sidebar)">
          <button class="pc-seg-btn" data-method="text" aria-pressed="false">Text</button>
          <button class="pc-seg-btn" data-method="semantic" aria-pressed="false">Semantic</button>
          <button class="pc-seg-btn" data-method="hybrid" aria-pressed="true">Hybrid</button>
        </div>
        <div style="display:flex; gap:8px; align-items:center; margin-top:8px">
          <label class="muted" style="font-size:12px">Max sources</label>
          <input id="pc-max-sources" type="number" class="btn" min="5" max="200" value="30" style="width:90px; text-align:center" />
        </div>
        <div style="display:flex; gap:8px; margin-top:8px">
          <button id="pc-strict" class="btn" aria-pressed="false" title="Require citations for every claim">Strict citations</button>
          <button id="pc-conservative" class="btn" aria-pressed="false" title="Prefer high-precision evidence">Conservative</button>
        </div>

        <div style="font-weight:900;margin:12px 0 8px">Provenance</div>
        <div class="muted" style="font-size:13px">Snapshot: <span id="pc-snapshot">—</span></div>
        <div class="muted" style="font-size:13px">Last run: <span id="pc-last-run">—</span></div>
        <button id="pc-show-trace" class="btn" style="margin-top:8px">Show reasoning trace</button>
      </div>
    </aside>
  </div>
</div>

<!-- Boot data for JS -->
<div id="pc-wireframe-data"
     data-collection-id="{{ collection.id }}"
     data-collection-name="{{ collection.name }}"
     data-snapshot-id="snapshot-{{ collection.id }}-{{ collection.name|slugify }}"
     hidden></div>

<script>
(function () {
  const $ = (s, el=document) => el.querySelector(s);
  const $$ = (s, el=document) => Array.from(el.querySelectorAll(s));
  const byId = (id) => document.getElementById(id);
  const fmt = (d) => new Date(d).toLocaleString();
  const clamp = (n, a, b) => Math.max(a, Math.min(b, n));
  const escapeHtml = s => (s||'').replace(/[&<>"']/g, m=> ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));

  const dataEl = byId('pc-wireframe-data');
  const STATE_KEY = `pc.qaw.v1.${dataEl.dataset.collectionId}`;
  const state = {
    method: 'hybrid', scopeLock: false, monitor: false, strict: false, conservative: false,
    maxSources: 30, yearRange: '2000–2025', snapshotId: dataEl.dataset.snapshotId,
    selectedId: null, questions: []
  };

  // --- storage
  function load(){ try{Object.assign(state, JSON.parse(localStorage.getItem(STATE_KEY)||'{}'));}catch{} }
  function save(){ try{localStorage.setItem(STATE_KEY, JSON.stringify(state));}catch{} }
  function uid(){ return 'q_' + Math.random().toString(36).slice(2,9); }
  function rnd(a,b){ return Math.floor(Math.random()*(b-a+1))+a; }

  // --- mock answer
  function skelAnswer(){
    const lines = [
      'High-level agreement that biosecurity and surveillance are critical.',
      'Evidence suggests persistent environmental survival and shedding dynamics.',
      'Heterogeneity across studies; rare extra-intestinal manifestations reported.'
    ];
    return {
      summary: lines.map(txt => ({ txt, cite: [rnd(1,10), rnd(1,10)] })),
      agree: ['Most studies find X increases risk under Y.', 'Consensus on A, with caveats in B.'],
      disagree: ['Conflicting reports on Z (2–3 studies disagree).'],
      gaps: ['Limited longitudinal data post-2022.', 'Few randomized comparisons across interventions.'],
      coverage: { years: Array.from({length:12},()=> rnd(2,18)), clusters: Array.from({length:8},()=> rnd(1,12)) }
    };
  }
  function skelSources(){
    return Array.from({length:8}).map((_,i)=>({ id:i+1, year:2016+(i%9), title:`Sample paper ${i+1}`, venue:i%2?'J. Vet. Sci.':'Epidemiology', url:'#' }));
  }

  // --- render helpers
  function renderBars(el, arr){
    el.innerHTML = '';
    if (!arr || !arr.length){ el.textContent = 'No data'; el.classList.add('muted'); return; }
    const mx = Math.max(...arr);
    arr.forEach(v => { const b=document.createElement('div'); b.style.height = (8+46*(v/mx))+'px'; el.appendChild(b); });
  }
  function renderAnswer(ans, sources){
    byId('pc-summary').innerHTML = ans.summary.map(s => `• ${escapeHtml(s.txt)} <span class="muted">[${s.cite.join(', ')}]</span>`).join('<br>');
    byId('pc-agree').innerHTML = ans.agree.map(x=> `<li>${escapeHtml(x)}</li>`).join('');
    byId('pc-disagree').innerHTML = ans.disagree.map(x=> `<li>${escapeHtml(x)}</li>`).join('');
    byId('pc-gaps').innerHTML = ans.gaps.map(x=> `<li>${escapeHtml(x)}</li>`).join('');
    renderBars(byId('pc-yearbars'), ans.coverage.years);
    renderBars(byId('pc-clusterbars'), ans.coverage.clusters);
    const box = byId('pc-sources'); box.innerHTML = '';
    sources.forEach(s => { const d=document.createElement('div'); d.className='pc-source';
      d.innerHTML = `<div style="font-weight:700">${escapeHtml(s.title)}</div><div class="muted" style="font-size:12px">${escapeHtml(s.venue)} · ${escapeHtml(String(s.year))}</div><a href="${s.url}">Open</a>`;
      box.appendChild(d);
    });
  }

  // --- model
  function createQuestion(prompt, method){
    const q = {
      id: uid(),
      title: (prompt||'').trim().replace(/\?+$/,'').slice(0,80) || 'Untitled question',
      prompt, method: method || state.method,
      scope: { yearRange: state.yearRange, chips: Array.from($('#pc-scope-chips')?.children||[]).map(x=>x.textContent) },
      params: { strict: state.strict, conservative: state.conservative, maxSources: state.maxSources },
      snapshotId: state.snapshotId, createdAt: Date.now(), lastRunAt: null, runs: []
    };
    state.questions.unshift(q); save(); renderLedger(); selectQuestion(q.id); setEmptyUI(); return q;
  }
  function selectQuestion(id){
    state.selectedId = id; save();
    const q = state.questions.find(x => x.id === id); if (!q) return;
    $$('#pc-q-list .pc-qcard').forEach(li => li.setAttribute('aria-selected', String(li.dataset.id === id)));
    byId('pc-answer-title').textContent = q.title;
    byId('pc-status-chip').textContent = q.lastRunAt ? 'Fresh' : 'Draft';
    byId('pc-last-run').textContent = q.lastRunAt ? fmt(q.lastRunAt) : '—';
    const delta = (q.lastRunAt ? rnd(0,4) : 0); const chip = byId('pc-delta-chip'); chip.hidden = !delta; chip.textContent = `Δ ${delta}`;
    if (q.runs.length){ const r=q.runs[q.runs.length-1]; renderAnswer(r.answer, r.sources); } else {
      byId('pc-summary').innerHTML = `<div class="skel" style="height:14px;width:95%"></div><div class="skel" style="height:14px;width:88%"></div><div class="skel" style="height:14px;width:72%"></div>`;
      ['pc-agree','pc-disagree','pc-gaps'].forEach(id=> byId(id).innerHTML = `<li class="skel" style="height:12px;width:90%"></li><li class="skel" style="height:12px;width:70%"></li>`);
      byId('pc-sources').innerHTML = Array.from({length:4}).map(()=> `<div class="pc-source"><div class="skel" style="height:12px;width:80%"></div><div class="skel" style="height:10px;width:40%;margin-top:6px"></div></div>`).join('');
      renderBars(byId('pc-yearbars'), []); renderBars(byId('pc-clusterbars'), []);
    }
    byId('pc-history').textContent = q.runs.length ? `v${q.runs.length} (last run ${fmt(q.runs[q.runs.length-1].createdAt)})` : 'No runs yet';
    setEmptyUI();
  }
  function renderLedger(){
    const list = byId('pc-q-list'); list.innerHTML = '';
    const filter = (byId('pc-query-filter').value||'').toLowerCase();
    (state.questions||[]).filter(q => !filter || q.title.toLowerCase().includes(filter) || q.prompt.toLowerCase().includes(filter))
      .forEach(q => {
        const li=document.createElement('li'); li.className='pc-qcard'; li.dataset.id=q.id;
        li.setAttribute('tabindex','0'); li.setAttribute('role','button');
        li.setAttribute('aria-selected', String(q.id===state.selectedId));
        li.innerHTML = `
          <div class="pc-qtitle">${escapeHtml(q.title)}</div>
          <div class="pc-qsub">${escapeHtml(q.prompt.slice(0,80))}${q.prompt.length>80?'…':''}</div>
          <div class="pc-chips"><span class="pc-chip ${q.lastRunAt?'':'muted'}">${q.lastRunAt?'Fresh':'Draft'}</span><span class="pc-chip">${escapeHtml(q.method)}</span></div>`;
        li.addEventListener('click', ()=> selectQuestion(q.id));
        li.addEventListener('keydown', (e)=> { if(e.key==='Enter'||e.key===' ') { e.preventDefault(); selectQuestion(q.id); }});
        list.appendChild(li);
      });
    setEmptyUI();
  }

  // --- run / rerun (mock)
  function runSelected(){
    const q = state.questions.find(x => x.id === state.selectedId); if (!q) return;
    q.method = state.method; q.params = { strict: state.strict, conservative: state.conservative, maxSources: state.maxSources };
    q.scope.yearRange = state.yearRange; q.snapshotId = state.snapshotId; q.lastRunAt = Date.now();
    const run = { id:'r_'+Math.random().toString(36).slice(2,9), createdAt: Date.now(), snapshotId: state.snapshotId, answer: skelAnswer(), sources: skelSources() };
    q.runs.push(run); save(); renderAnswer(run.answer, run.sources); renderLedger(); byId('pc-last-run').textContent = fmt(q.lastRunAt);
  }

  // --- ui mode toggle
  function setEmptyUI(){
    const isEmpty = !state.questions.length && !state.selectedId;
    byId('pc-qaw').classList.toggle('is-empty', isEmpty);
    // focus the hero input when empty
    if (isEmpty) setTimeout(()=> byId('pc-ask-hero').focus(), 50);
  }

  // --- method sync
  function setMethod(m){ state.method = m; $$('.pc-seg-btn').forEach(b=> b.dataset.method && b.setAttribute('aria-pressed', String(b.dataset.method===m))); save(); }

  // --- keyboard: / to focus, Enter to run
  function bindAskEnter(input){
    input.addEventListener('keydown', (e)=>{
      if (e.key==='Enter' && !e.shiftKey){
        e.preventDefault();
        const v=(input.value||'').trim(); if (!v) return;
        if (!state.selectedId) createQuestion(v, state.method); else {
          const q=state.questions.find(x=>x.id===state.selectedId);
          q.prompt=v; q.title=(v.replace(/\?+$/,'').slice(0,80)||q.title); save(); renderLedger();
        }
        runSelected();
      }
    });
  }

  function init(){
    load();
    // controls
    $$('.pc-seg-btn').forEach(btn => btn.addEventListener('click', ()=> setMethod(btn.dataset.method)));
    byId('pc-new-q').addEventListener('click', ()=> createQuestion(byId('pc-ask').value || 'What is the consensus on X?', state.method));
    byId('pc-run-top').addEventListener('click', ()=> { if (!state.selectedId) createQuestion(byId('pc-ask').value || 'What is the consensus on X?', state.method); runSelected(); });
    byId('pc-rerun').addEventListener('click', runSelected);
    byId('pc-max-sources').addEventListener('input', e=> { state.maxSources = clamp(parseInt(e.target.value||'30',10),5,200); save(); });
    byId('pc-year-range').addEventListener('change', e=> { state.yearRange = e.target.value || state.yearRange; save(); });
    byId('pc-query-filter').addEventListener('input', renderLedger);

    // splash interactions
    bindAskEnter(byId('pc-ask'));
    bindAskEnter(byId('pc-ask-hero'));
    byId('pc-run-hero').addEventListener('click', ()=>{
      const v=(byId('pc-ask-hero').value||'').trim(); if (!v) return;
      createQuestion(v, state.method); runSelected();
    });
    $$('#pc-splash .pc-suggest .pc-chip').forEach(ch=>{
      ch.addEventListener('click', ()=>{
        const placeholder = (byId('pc-ask-hero').value || '{topic}').trim() || '{topic}';
        const tpl = ch.dataset.suggest.replace(/\{topic\}/g, placeholder).replace(/\{A\}/g,'A').replace(/\{B\}/g,'B');
        byId('pc-ask-hero').value = tpl; byId('pc-ask').value = tpl; byId('pc-ask-hero').focus();
      });
    });

    // global hotkey: '/' focuses hero (empty) or sticky ask (normal)
    document.addEventListener('keydown', (e)=>{
      if (e.key === '/' && !e.metaKey && !e.ctrlKey && !e.altKey){
        e.preventDefault();
        const isEmpty = byId('pc-qaw').classList.contains('is-empty');
        (isEmpty ? byId('pc-ask-hero') : byId('pc-ask')).focus();
      }
    });

    renderLedger();
    if (state.selectedId && state.questions.some(q=> q.id===state.selectedId)) selectQuestion(state.selectedId);
    setEmptyUI();
  }

  init();
})();
</script>

{% endblock %}
